<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple Linear Regression (SLR) — Calculator</title>

  <!-- Bootstrap (local) -->
  <link href="./css/bootstrap.min.css" rel="stylesheet"/>
  <script src="./js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome (local) -->
  <link rel="stylesheet" href="./css/font-awesome.min.css"/>

  <style>
    :root{
      --bg:#0f172a;
      --card:#111c33;
      --card2:#0b1224;
      --text:#f8fafc;
      --muted:#94a3b8;
      --border:rgba(148,163,184,0.25);
      --accent:#38bdf8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    body{
      background: radial-gradient(1100px 700px at 20% 0%, rgba(56,189,248,0.15), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(34,197,94,0.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Inter", Arial, sans-serif;
      min-height:100vh;
    }

    .container{ max-width: 1180px; }

    .app-title{
      letter-spacing: .2px;
      font-weight: 800;
      text-shadow: 0 1px 12px rgba(0,0,0,0.35);
    }

    .subtle{ color: rgba(226, 232, 240, 0.78); }

    .card{
      background: rgba(17, 28, 51, 0.88);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }

    /* ===== Header contrast improvements ===== */
    .card-header{
      border-bottom: 1px solid rgba(148,163,184,0.25);
      position: relative;
      background: rgba(11, 18, 36, 0.94);
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
    }
    .card-header::after{
      content:"";
      position:absolute;
      inset:0;
      border-top-left-radius: 18px;
      border-top-right-radius: 18px;
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(56,189,248,0.18), transparent 55%),
        radial-gradient(900px 220px at 80% 0%, rgba(34,197,94,0.12), transparent 55%);
      pointer-events:none;
    }
    .card-header > *{ position: relative; z-index: 1; }
    .card-header .fw-bold,
    .card-header .fw-semibold,
    .card-header h1,
    .card-header h2,
    .card-header h3{ 
      color: rgba(248,250,252,0.96) !important;
      text-shadow: 0 1px 10px rgba(0,0,0,0.35);
    }
    .card-header, .card-header *{ color: rgba(248,250,252,0.95) !important; }
    .card-header .small-note{ color: rgba(226,232,240,0.82) !important; }

    .form-label, .form-check-label{
      color: rgba(248, 250, 252, 0.92) !important;
    }

    .form-control, .form-select, textarea.form-control{
      background-color: rgba(255,255,255,0.04);
      color: var(--text);
      border: 1px solid rgba(148,163,184,0.28);
      border-radius: 12px;
    }
    .form-control::placeholder{ color: rgba(226,232,240,0.55); }

    select option{
      background-color: #0b1224;
      color: #f8fafc;
    }

    .form-control:focus, .form-select:focus{
      box-shadow: 0 0 0 .25rem rgba(56,189,248,.15);
      border-color: rgba(56,189,248,.55);
    }

    .btn{ border-radius: 12px; font-weight: 650; }
    .btn-primary{
      background: linear-gradient(180deg, rgba(56,189,248,0.95), rgba(56,189,248,0.75));
      border: none;
    }
    .btn-outline-light{
      border-color: rgba(248,250,252,.35);
      color: var(--text);
    }
    .btn-outline-light:hover{
      border-color: rgba(56,189,248,.65);
      color: var(--text);
      background: rgba(56,189,248,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.35rem .65rem;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,0.25);
      background: rgba(255,255,255,0.03);
      color: rgba(226,232,240,0.82);
      font-size:.9rem;
    }

    .help-i{
      color: rgba(248,250,252,.80);
      cursor: help;
      margin-left:.35rem;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .result-box{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(2,6,23,0.66));
      border:1px solid rgba(148,163,184,0.20);
      border-radius: 14px;
      padding: 1rem;
      backdrop-filter: blur(6px);
    }

    /* Improve header contrast inside cards/result boxes */
    .result-box .fw-bold,
    .result-box .fw-semibold,
    .result-box h1,
    .result-box h2,
    .result-box h3{
      color: rgba(248,250,252,0.96) !important;
      text-shadow: 0 1px 12px rgba(0,0,0,0.40);
    }

    /* Responsive KPI grid: cards wrap automatically instead of shrinking too much */
    .kpi{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: .75rem;
    }
    .kpi .k{
      min-width: 0;  /* critical: allow grid items to shrink properly without overflow */
      overflow: hidden;
      padding:.85rem;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,0.25);
      background: rgba(255,255,255,0.03);
      min-height: 92px;
    }
    .k .label{
      color: rgba(248,250,252,0.92);
      font-size: .95rem;
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    /* Default KPI values can wrap (equations especially) */
    .k .value{
      font-size: 1.2rem;
      font-weight: 800;
      margin-top:.25rem;
      color: rgba(248,250,252,0.96);
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: normal;
      line-height: 1.25;
    }
    /* Use this ONLY for numeric outputs that should not wrap */
    .k .value.nowrap{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Optional: equations get slightly smaller on tight screens */
    @media (max-width: 576px){
      .kpi .value{ font-size: 1.05rem; }
    }

    .status-good{ color: var(--good); }
    .status-warn{ color: var(--warn); }
    .status-bad{ color: var(--bad); }

    .small-note{
      color: rgba(226, 232, 240, 0.80);
      font-size: .92rem;
    }

    .table-wrap{
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.30);
      background: rgba(2, 6, 23, 0.55);
    }

    .table-wrap table{
      width: 100%;
      margin: 0;
      color: var(--text);
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Only enforce larger minimum width on tables marked as 'wide' */
    .table-wrap.table-wide table{
      min-width: 860px;
    }

    table{ margin:0; width:100%; color: var(--text); }
    thead th{
      position: sticky; top:0;
      background: rgba(2, 6, 23, 0.92);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(148,163,184,0.30) !important;
      z-index: 2;
    }
    td, th{
      border-color: rgba(148,163,184,0.22) !important;
      vertical-align: middle;
    }

    .hr-soft{ border-color: rgba(148,163,184,.18); opacity: 1; }

    /* Steps */
    .step{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(148,163,184,0.22);
      border-left: 3px solid rgba(56,189,248,.55);
      border-radius: 14px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .step .fw-semibold{ color: rgba(248,250,252,0.96) !important; }
    .step .small-note{ color: rgba(226,232,240,0.86) !important; }

    /* Write-up */
    #writeupPreview{
      color: rgba(248,250,252,0.94);
      background: rgba(2,6,23,0.58);
      border: 1px solid rgba(148,163,184,0.22);
      border-radius: 12px;
      padding: 12px 14px;
      line-height: 1.5;
      overflow:auto;
      white-space: pre-wrap;
      margin:0;
    }
    details > summary{
      color: rgba(226,232,240,0.92) !important;
      cursor:pointer;
    }

    /* Mobile table readability improvements */
    @media (max-width: 576px){
      .table-wrap{
        border-radius: 12px;
      }

      .table-wrap table{
        font-size: 0.88rem;
      }

      .table-wrap th,
      .table-wrap td{
        padding: .55rem .6rem;
        white-space: nowrap;
      }

      .step{
        padding: .85rem;
      }
      .step .fw-semibold{
        font-size: 1rem;
      }
      .result-box{
        padding: .85rem;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
      <div>
        <div class="pill mb-2">
          <i class="fa-solid fa-chart-line"></i>
          Simple Linear Regression
          <span class="mx-1">•</span>
          <span class="subtle">SLR (one X, one Y)</span>
        </div>
        <h1 class="app-title mb-1">Simple Linear Regression (SLR) — Calculator</h1>
        <div class="subtle">
          Fit <span class="mono">Ŷ = b0 + b1X</span>, compute inference (t-test, CI), ANOVA, and compute intervals at <span class="mono">X0</span> (mean CI and prediction interval).
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="btnReset" class="btn btn-outline-light">
          <i class="fa-solid fa-rotate-left me-2"></i>Reset
        </button>
        <button id="btnComputeTop" class="btn btn-primary">
          <i class="fa-solid fa-calculator me-2"></i>Compute
        </button>
      </div>
    </div>

    <div class="row g-3">
      <!-- Inputs -->
      <div class="col-12 col-lg-4 order-2 order-lg-1">
        <div class="card h-100">
          <div class="card-header p-3">
            <div class="d-flex align-items-center justify-content-between">
              <div class="fw-bold">Inputs & Settings</div>
              <span class="pill"><i class="fa-solid fa-sliders"></i> Generic SLR</span>
            </div>
          </div>
          <div class="card-body p-3">

            <!-- Mode -->
            <div class="mb-3">
              <label class="form-label">
                Input mode
                <i class="fa-solid fa-circle-info help-i"
                   data-bs-toggle="tooltip"
                   title="Choose how your problem provides data: (1) raw (x,y) pairs, (2) summary statistics, or (3) regression output/partial stats."></i>
              </label>
              <select id="modeSelect" class="form-select">
                <option value="raw">Raw data: (x, y) pairs</option>
                <option value="summary">Summary stats: n, x̄, ȳ, sₓ, sᵧ, r</option>
                <option value="output">Regression output: b0, b1 + SE info</option>
              </select>
              <div class="small-note mt-2">
                Tip: Intervals at X0 require <span class="mono">x̄</span>, <span class="mono">Sxx</span>, and an estimate of <span class="mono">s</span> (RMSE).
              </div>
            </div>

            <!-- Raw -->
            <div id="modeRaw" class="mb-3">
              <label class="form-label">
                Data pairs (one per line)
                <i class="fa-solid fa-circle-info help-i"
                   data-bs-toggle="tooltip"
                   title="Enter x and y for each observation. Examples: '12, 5' or '12 5'. The calculator will compute all needed statistics."></i>
              </label>
              <textarea id="rawPairs" class="form-control" rows="8"
                        placeholder="Example:
10, 72
11, 74
12, 79
..."></textarea>
              <div class="small-note mt-2">
                Accepted separators: comma, space, or tab. Empty lines are ignored.
              </div>
            </div>

            <!-- Summary -->
            <div id="modeSummary" class="mb-3 d-none">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">
                    n
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample size (number of observations)."></i>
                  </label>
                  <input id="nSummary" class="form-control" type="number" min="3" step="1" value="30">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    r
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample correlation coefficient between X and Y (−1 ≤ r ≤ 1)."></i>
                  </label>
                  <input id="rSummary" class="form-control" type="number" step="0.0001" value="0.6">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    x̄
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample mean of X (average X). Needed for intervals at X0 because they depend on (X0−x̄)."></i>
                  </label>
                  <input id="xbarSummary" class="form-control" type="number" step="0.0001" value="50">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    ȳ
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample mean of Y (average Y). Used to compute b0 = ȳ − b1·x̄."></i>
                  </label>
                  <input id="ybarSummary" class="form-control" type="number" step="0.0001" value="100">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    sₓ
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample standard deviation of X. Must be > 0. Determines Sxx = (n−1)sx²."></i>
                  </label>
                  <input id="sxSummary" class="form-control" type="number" step="0.0001" value="10">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    sᵧ
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample standard deviation of Y. Must be > 0. Determines SST = (n−1)sy²."></i>
                  </label>
                  <input id="sySummary" class="form-control" type="number" step="0.0001" value="20">
                </div>
              </div>
              <div class="small-note mt-2">
                In summary mode: <span class="mono">b1 = r·(sᵧ/sₓ)</span>, <span class="mono">b0 = ȳ − b1·x̄</span>, and ANOVA uses <span class="mono">R²=r²</span>.
              </div>
            </div>

            <!-- Output mode -->
            <div id="modeOutput" class="mb-3 d-none">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">
                    b0 (intercept)
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Intercept of the fitted line Ŷ = b0 + b1X."></i>
                  </label>
                  <input id="b0Out" class="form-control" type="number" step="0.000001" value="0">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    b1 (slope)
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Slope of the fitted line (change in Ŷ for +1 change in X)."></i>
                  </label>
                  <input id="b1Out" class="form-control" type="number" step="0.000001" value="1">
                </div>

                <div class="col-6">
                  <label class="form-label">
                    n
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sample size. Used for degrees of freedom (df = n−2) and inference."></i>
                  </label>
                  <input id="nOut" class="form-control" type="number" min="3" step="1" value="30">
                </div>
                <div class="col-6">
                  <label class="form-label">
                    x̄
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Mean of X. Required for confidence/prediction intervals at X0 because they depend on (X0−x̄)."></i>
                  </label>
                  <input id="xbarOut" class="form-control" type="number" step="0.0001" placeholder="Provide if needed for intervals">
                </div>

                <div class="col-12">
                  <label class="form-label">
                    SSX = Σ(x−x̄)² (Sxx)
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="Sum of squares for X. Needed for SE(b1) and for intervals at X0. Must be > 0."></i>
                  </label>
                  <input id="ssxOut" class="form-control" type="number" step="0.0001" value="1000">
                </div>

                <div class="col-12">
                  <label class="form-label">
                    Provide ONE of these for uncertainty
                    <i class="fa-solid fa-circle-info help-i"
                       data-bs-toggle="tooltip"
                       title="To compute t-tests and intervals, the calculator needs the regression error scale s (RMSE) or enough info to derive it. Provide SE(b1) OR RMSE OR SSE."></i>
                  </label>

                  <div class="row g-2">
                    <div class="col-4">
                      <input id="seB1Out" class="form-control" type="number" step="0.000001" placeholder="SE(b1)">
                    </div>
                    <div class="col-4">
                      <input id="rmseOut" class="form-control" type="number" step="0.000001" placeholder="RMSE">
                    </div>
                    <div class="col-4">
                      <input id="sseOut" class="form-control" type="number" step="0.000001" placeholder="SSE">
                    </div>
                  </div>
                  <div class="small-note mt-2">
                    Priority: SE(b1) → RMSE → SSE. If only SE(b1) is provided, the calculator derives <span class="mono">RMSE = SE(b1)·√Sxx</span>.
                  </div>
                </div>
              </div>
            </div>

            <hr class="hr-soft my-3">

            <!-- Test settings -->
            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">
                  Significance level (α)
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="Type I error probability used in hypothesis testing. Common: 0.05 or 0.01."></i>
                </label>
                <div class="input-group">
                  <select id="alphaSelect" class="form-select">
                    <option value="0.10">0.10</option>
                    <option value="0.05" selected>0.05</option>
                    <option value="0.01">0.01</option>
                  </select>
                  <button id="btnAlphaCustom" class="btn btn-outline-light" type="button"
                          data-bs-toggle="tooltip"
                          title="Enter any α (for example 0.025).">
                    Custom
                  </button>
                </div>
                <input id="alphaCustom" class="form-control mt-2 d-none" type="number"
                       step="0.001" min="0.0001" max="0.5" value="0.05">
              </div>
              <div class="col-6">
                <label class="form-label">
                  Alternative (H1)
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="Choose the direction of the test for association: two-sided, positive, or negative."></i>
                </label>
                <select id="h1Select" class="form-select">
                  <option value="two" selected>ρ ≠ 0 (two-sided)</option>
                  <option value="gt">ρ > 0 (right-tailed)</option>
                  <option value="lt">ρ < 0 (left-tailed)</option>
                </select>
              </div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">
                  Confidence level (for CIs/intervals)
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="This confidence level is used for CI(b1), CI for mean response at X0, and prediction interval at X0."></i>
                </label>
                <div class="input-group">
                  <select id="confSelect" class="form-select">
                    <option value="0.90">90%</option>
                    <option value="0.95" selected>95%</option>
                    <option value="0.99">99%</option>
                  </select>
                  <button id="btnConfCustom" class="btn btn-outline-light" type="button"
                          data-bs-toggle="tooltip"
                          title="Enter any confidence level (for example 0.975).">
                    Custom
                  </button>
                </div>
                <input id="confCustom" class="form-control mt-2 d-none" type="number"
                       step="0.001" min="0.50" max="0.9999" value="0.95">
              </div>
              <div class="col-6">
                <label class="form-label">
                  Predictions & intervals at X0
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="Enable to compute Ŷ(X0), deltaŶ, CI for mean response at X0, and prediction interval at X0 (if inputs are sufficient)."></i>
                </label>
                <div class="form-check form-switch mt-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="predToggle" checked>
                  <label class="form-check-label" for="predToggle">Enable</label>
                </div>
              </div>
            </div>

            <div id="predBlock" class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">
                  X0
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="Point where you want the prediction Ŷ(X0) and intervals. Intervals require x̄, Sxx, and RMSE (or equivalent)."></i>
                </label>
                <input id="x0Input" class="form-control" type="number" step="0.0001" placeholder="e.g., 60">
              </div>
              <div class="col-6">
                <label class="form-label">
                  deltaX
                  <i class="fa-solid fa-circle-info help-i"
                     data-bs-toggle="tooltip"
                     title="For 'change' questions: predicted deltaŶ = b1·deltaX."></i>
                </label>
                <input id="dxInput" class="form-control" type="number" step="0.0001" placeholder="e.g., 5">
              </div>
              <div class="col-12 small-note">
                Ŷ(X0) = b0 + b1·X0, deltaŶ = b1·deltaX.
                Intervals at X0:
                <span class="mono">CI_mean: Ŷ ± t*·s·√(1/n + (X0−x̄)²/Sxx)</span>,
                <span class="mono">PI: Ŷ ± t*·s·√(1 + 1/n + (X0−x̄)²/Sxx)</span>.
              </div>
            </div>

            <div class="d-grid gap-2">
              <button id="btnCompute" class="btn btn-primary">
                <i class="fa-solid fa-calculator me-2"></i>Compute
              </button>
              <button id="btnExample" class="btn btn-outline-light">
                <i class="fa-solid fa-wand-magic-sparkles me-2"></i>Load a generic example
              </button>
            </div>

            <hr class="hr-soft my-3">

            <div class="result-box">
              <div class="fw-semibold mb-2">
                What this calculator covers (generic)
                <i class="fa-solid fa-circle-info help-i"
                   data-bs-toggle="tooltip"
                   title="This text is generic so you can reuse the tool for any course/exercise set."></i>
              </div>

              <div class="small-note">
                <b>Covers:</b> estimating the regression line <span class="mono">Ŷ=b0+b1X</span>, computing <span class="mono">r</span> and <span class="mono">R²</span>,
                testing association (<span class="mono">H0: ρ=0</span> / <span class="mono">b1=0</span>), confidence interval for <span class="mono">b1</span>,
                ANOVA (<span class="mono">SST=SSR+SSE</span>, <span class="mono">F</span>), and predictions.
                Also computes <b>CI for mean response at X0</b> and <b>prediction interval at X0</b> when inputs are sufficient.
                <br><br>
                <b>Not covered:</b> multiple regression (more than one predictor), categorical predictors/dummies, advanced diagnostics, and special transformations workflows.
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="col-12 col-lg-8 order-1 order-lg-2">
        <div class="card">
          <div class="card-header p-3">
            <div class="fw-bold">Results</div>
          </div>
          <div class="card-body p-3">
            <div id="errorBox" class="alert alert-danger d-none mb-3"></div>

            <!-- KPIs -->
            <div class="kpi mb-3">
              <div class="k">
                <div class="label">Regression line</div>
                <div id="kpiLine" class="value mono">—</div>
              </div>
              <div class="k">
                <div class="label">r and R²</div>
                <div id="kpiR2" class="value mono nowrap">—</div>
              </div>
              <div class="k">
                <div class="label">t-stat / df</div>
                <div id="kpiT" class="value mono nowrap">—</div>
              </div>
              <div class="k">
                <div class="label">p-value / decision</div>
                <div id="kpiDecision" class="value nowrap">—</div>
              </div>
            </div>

            <!-- Model box + ANOVA -->
            <div class="row g-3 mb-3">
              <div class="col-12 col-xl-5">
                <div class="result-box">
                  <div class="fw-semibold mb-2">Model & formulas</div>
                  <div id="modelBox" class="small-note"></div>
                </div>
              </div>
              <div class="col-12 col-xl-7">
                <div class="result-box">
                  <div class="fw-semibold mb-2">ANOVA (Excel-style)</div>
                  <div id="anovaBox"></div>
                  <div id="anovaNote" class="small-note mt-2"></div>
                </div>
              </div>
            </div>

            <!-- Uncertainty -->
            <div class="row g-3 mb-3">
              <div class="col-12 col-lg-6">
                <div class="result-box">
                  <div class="fw-semibold mb-2">Model accuracy and uncertainty</div>
                  <div class="kpi">
                    <div class="k">
                      <div class="label">SSE</div>
                      <div id="kpiSSE" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">RMSE (s)</div>
                      <div id="kpiRMSE" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">SE(b1)</div>
                      <div id="kpiSEb1" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">CI for b1</div>
                      <div id="kpiCIb1" class="value mono nowrap">—</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 col-lg-6">
                <div class="result-box">
                  <div class="fw-semibold mb-2">Predictions & intervals at X0</div>
                  <div class="kpi">
                    <div class="k">
                      <div class="label">Ŷ at X0</div>
                      <div id="kpiYhatX0" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">deltaŶ for deltaX</div>
                      <div id="kpiDY" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">CI(mean) at X0</div>
                      <div id="kpiCIMeanX0" class="value mono nowrap">—</div>
                    </div>
                    <div class="k">
                      <div class="label">Prediction interval at X0</div>
                      <div id="kpiPIX0" class="value mono nowrap">—</div>
                    </div>
                  </div>
                  <div id="intervalNote" class="small-note mt-2"></div>
                </div>
              </div>
            </div>

            <!-- Steps -->
            <div class="result-box mb-3">
              <div class="fw-semibold mb-2">
                Step-by-step solution
                <span class="pill ms-2">Homework style</span>
              </div>
              <div id="stepsContainer"></div>
            </div>

            <!-- Write-up -->
            <div class="result-box">
              <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                <div class="fw-semibold">Homework write-up (auto-generated)</div>
                <button id="btnCopyWriteup" class="btn btn-outline-light btn-sm">
                  <i class="fa-solid fa-copy me-2"></i>Copy write-up
                </button>
              </div>
              <details open>
                <summary class="small-note">Show/Hide write-up</summary>
                <pre id="writeupPreview" class="mono mt-3"></pre>
              </details>
            </div>

            <div class="d-flex justify-content-end mt-3">
              <button id="btnComputeBottom" class="btn btn-primary">
                <i class="fa-solid fa-calculator me-2"></i>Compute
              </button>
            </div>

          </div>
        </div>
      </div>
    </div><!-- row -->
  </div><!-- container -->

  <script>
    /***********************
     * Helpers
     ***********************/
    function fmt(x, digits=4){
      if (!isFinite(x)) return "—";
      const abs = Math.abs(x);
      // Small p-values: show scientific notation for readability
      if (abs !== 0 && abs < 0.0001) return x.toExponential(3);
      return Number(x).toFixed(digits);
    }
    function showError(msg){
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.classList.remove("d-none");
    }
    function clearError(){
      const box = document.getElementById("errorBox");
      box.textContent = "";
      box.classList.add("d-none");
    }

    function initTooltips(){
      const list = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      list.forEach(el => {
        const existing = bootstrap.Tooltip.getInstance(el);
        if (existing) existing.dispose();
        new bootstrap.Tooltip(el, {container:'body', trigger:'hover focus'});
      });
    }

    /***********************
     * Beta/Gamma -> t and F
     ***********************/
    function gammaln(xx){
      const cof=[76.18009172947146,-86.50532032941677,24.01409824083091,-1.231739572450155,0.001208650973866179,-0.000005395239384953];
      let x=xx-1.0, tmp=x+5.5;
      tmp -= (x+0.5)*Math.log(tmp);
      let ser=1.000000000190015;
      for (let j=0;j<cof.length;j++){ x+=1; ser += cof[j]/x; }
      return -tmp + Math.log(2.5066282746310005*ser);
    }

    function betacf(a,b,x){
      const MAXIT=200, EPS=3e-12, FPMIN=1e-300;
      let qab=a+b, qap=a+1, qam=a-1;
      let c=1, d=1 - qab*x/qap;
      if (Math.abs(d)<FPMIN) d=FPMIN;
      d=1/d;
      let h=d;
      for (let m=1;m<=MAXIT;m++){
        let m2=2*m;
        let aa = m*(b-m)*x/((qam+m2)*(a+m2));
        d=1+aa*d; if (Math.abs(d)<FPMIN) d=FPMIN; d=1/d;
        c=1+aa/c; if (Math.abs(c)<FPMIN) c=FPMIN;
        h *= d*c;

        aa = -(a+m)*(qab+m)*x/((a+m2)*(qap+m2));
        d=1+aa*d; if (Math.abs(d)<FPMIN) d=FPMIN; d=1/d;
        c=1+aa/c; if (Math.abs(c)<FPMIN) c=FPMIN;
        let del=d*c;
        h *= del;
        if (Math.abs(del-1.0) < EPS) break;
      }
      return h;
    }

    function betai(a,b,x){
      if (x<0 || x>1) return NaN;
      if (x===0 || x===1) return x;
      const bt = Math.exp(gammaln(a+b)-gammaln(a)-gammaln(b) + a*Math.log(x) + b*Math.log(1-x));
      if (x < (a+1)/(a+b+2)){
        return bt*betacf(a,b,x)/a;
      } else {
        return 1 - bt*betacf(b,a,1-x)/b;
      }
    }

    function tCdf(t, df){
      if (!isFinite(t) || !isFinite(df) || df<=0) return NaN;
      if (t===0) return 0.5;
      const x = df/(df + t*t);
      const ib = betai(df/2, 0.5, x);
      if (t>0) return 1 - 0.5*ib;
      return 0.5*ib;
    }

    function tInv(p, df){
      if (!(p>0 && p<1) || !(df>0)) return NaN;
      if (p===0.5) return 0;
      let lo=-80, hi=80;
      for (let i=0;i<220;i++){
        const mid=(lo+hi)/2;
        const c=tCdf(mid,df);
        if (c< p) lo=mid; else hi=mid;
      }
      return (lo+hi)/2;
    }

    function fCdf(F, d1, d2){
      if (!isFinite(F) || !isFinite(d1) || !isFinite(d2) || d1<=0 || d2<=0) return NaN;
      if (F<=0) return 0;
      const x = (d1*F)/(d1*F + d2);
      return betai(d1/2, d2/2, x);
    }
    function fRightTailPValue(F, d1, d2){
      const cdf = fCdf(F,d1,d2);
      if (!isFinite(cdf)) return NaN;
      return 1 - cdf;
    }

    /***********************
     * Parsing raw pairs
     ***********************/
    function parsePairs(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
      const xs=[], ys=[];
      for (const line of lines){
        const parts = line.split(/[, \t]+/).filter(p=>p.length>0);
        if (parts.length<2) continue;
        const x = parseFloat(parts[0]);
        const y = parseFloat(parts[1]);
        if (!isFinite(x) || !isFinite(y)) continue;
        xs.push(x); ys.push(y);
      }
      return {xs, ys};
    }

    /***********************
     * Core compute
     ***********************/
    function getAlpha(){
      const customVisible = !document.getElementById("alphaCustom").classList.contains("d-none");
      if (customVisible){
        let a = parseFloat(document.getElementById("alphaCustom").value);
        if (!isFinite(a) || a <= 0 || a >= 1) a = 0.05;
        return a;
      }
      return parseFloat(document.getElementById("alphaSelect").value);
    }
    function getH1(){ return document.getElementById("h1Select").value; }
    function getConf(){
      const customVisible = !document.getElementById("confCustom").classList.contains("d-none");
      if (customVisible){
        let c = parseFloat(document.getElementById("confCustom").value);
        if (!isFinite(c) || c <= 0.5 || c >= 1) c = 0.95;
        return c;
      }
      return parseFloat(document.getElementById("confSelect").value);
    }

    function compute(){
      clearError();

      const mode = document.getElementById("modeSelect").value;
      const alpha = getAlpha();
      const h1 = getH1();
      const conf = getConf();

      let n, df;
      let b0, b1, r, R2;
      let xbar, ybar;
      let SSx, SSy, SSE, SSR, SST;
      let MSE, RMSE;
      let se_b1;
      let tstat, pval;
      let tcrit;
      let ci_b1 = [NaN, NaN];

      // Intervals at X0
      let se_mean = NaN, se_pred = NaN;
      let ci_mean_x0 = [NaN, NaN];
      let pi_x0 = [NaN, NaN];

      // predictions
      const predOn = document.getElementById("predToggle").checked;
      const x0 = predOn ? parseFloat(document.getElementById("x0Input").value) : NaN;
      const dx = predOn ? parseFloat(document.getElementById("dxInput").value) : NaN;
      let yhatX0 = NaN;
      let dyhat = NaN;

      if (mode === "raw"){
        const {xs, ys} = parsePairs(document.getElementById("rawPairs").value);
        n = xs.length;
        if (n < 3){
          showError("Raw data mode requires at least 3 (x,y) pairs.");
          return null;
        }
        df = n - 2;

        xbar = xs.reduce((a,v)=>a+v,0)/n;
        ybar = ys.reduce((a,v)=>a+v,0)/n;

        SSx = xs.reduce((a,v)=>a + (v-xbar)*(v-xbar), 0);
        SSy = ys.reduce((a,v)=>a + (v-ybar)*(v-ybar), 0);
        const SSxy = xs.reduce((a,v,i)=>a + (v-xbar)*(ys[i]-ybar), 0);

        if (SSx <= 0){
          showError("Cannot fit SLR: Sxx is 0 (all X values are identical).");
          return null;
        }

        b1 = SSxy / SSx;
        b0 = ybar - b1*xbar;

        r = SSxy / Math.sqrt(SSx*SSy);
        R2 = r*r;

        SSE = 0;
        for (let i=0;i<n;i++){
          const yhat = b0 + b1*xs[i];
          const e = ys[i] - yhat;
          SSE += e*e;
        }
        SST = SSy;
        SSR = SST - SSE;

        MSE = SSE / df;
        RMSE = Math.sqrt(MSE);

        se_b1 = RMSE / Math.sqrt(SSx);
        tstat = b1 / se_b1;

      } else if (mode === "summary"){
        n = parseInt(document.getElementById("nSummary").value, 10);
        r = parseFloat(document.getElementById("rSummary").value);
        xbar = parseFloat(document.getElementById("xbarSummary").value);
        ybar = parseFloat(document.getElementById("ybarSummary").value);
        const sx = parseFloat(document.getElementById("sxSummary").value);
        const sy = parseFloat(document.getElementById("sySummary").value);

        if (!(n>=3) || !isFinite(r) || !isFinite(xbar) || !isFinite(ybar) || !(sx>0) || !(sy>0)){
          showError("Summary stats mode requires valid n (>=3), r, x̄, ȳ, sₓ>0, sᵧ>0.");
          return null;
        }
        if (Math.abs(r) > 1){
          showError("r must be between −1 and 1.");
          return null;
        }

        df = n - 2;

        SSx = (n-1) * sx*sx;
        SSy = (n-1) * sy*sy;

        b1 = r * (sy / sx);
        b0 = ybar - b1*xbar;
        R2 = r*r;

        SST = SSy;
        SSR = R2 * SST;
        SSE = (1 - R2) * SST;

        MSE = SSE / df;
        RMSE = Math.sqrt(MSE);

        se_b1 = RMSE / Math.sqrt(SSx);
        tstat = b1 / se_b1;

      } else {
        // output mode
        b0 = parseFloat(document.getElementById("b0Out").value);
        b1 = parseFloat(document.getElementById("b1Out").value);
        n = parseInt(document.getElementById("nOut").value, 10);
        xbar = parseFloat(document.getElementById("xbarOut").value);
        SSx = parseFloat(document.getElementById("ssxOut").value);

        if (!isFinite(b0) || !isFinite(b1) || !(n>=3)){
          showError("Output mode requires valid b0, b1, and n (>=3).");
          return null;
        }
        df = n - 2;

        const seGiven = parseFloat(document.getElementById("seB1Out").value);
        const rmseGiven = parseFloat(document.getElementById("rmseOut").value);
        const sseGiven = parseFloat(document.getElementById("sseOut").value);

        if (isFinite(seGiven) && seGiven > 0){
          se_b1 = seGiven;
          if (SSx > 0){
            RMSE = se_b1 * Math.sqrt(SSx); // derive s
            MSE = RMSE*RMSE;
            SSE = MSE * df;
          }
          tstat = b1 / se_b1;
        } else if (isFinite(rmseGiven) && rmseGiven > 0){
          if (!(SSx > 0)){
            showError("To use RMSE, Sxx must be provided and > 0.");
            return null;
          }
          RMSE = rmseGiven;
          MSE = RMSE*RMSE;
          SSE = MSE * df;
          se_b1 = RMSE / Math.sqrt(SSx);
          tstat = b1 / se_b1;
        } else if (isFinite(sseGiven) && sseGiven > 0){
          if (!(SSx > 0)){
            showError("To use SSE, Sxx must be provided and > 0.");
            return null;
          }
          SSE = sseGiven;
          MSE = SSE / df;
          RMSE = Math.sqrt(MSE);
          se_b1 = RMSE / Math.sqrt(SSx);
          tstat = b1 / se_b1;
        } else {
          se_b1 = NaN;
          tstat = NaN;
        }

        r = NaN; R2 = NaN;
        SSR = NaN; SST = NaN;
        ybar = NaN; SSy = NaN;
      }

      // t critical for confidence intervals
      const alphaCI = 1 - conf;
      tcrit = tInv(1 - alphaCI/2, df);

      // p-value from t distribution
      if (isFinite(tstat)){
        if (h1 === "two"){
          const pRight = 1 - tCdf(Math.abs(tstat), df);
          pval = 2*pRight;
        } else if (h1 === "gt"){
          pval = 1 - tCdf(tstat, df);
        } else {
          pval = tCdf(tstat, df);
        }
      } else {
        pval = NaN;
      }

      // CI for b1
      if (isFinite(se_b1)){
        ci_b1 = [b1 - tcrit*se_b1, b1 + tcrit*se_b1];
      }

      // Predictions
      if (predOn){
        if (isFinite(x0)) yhatX0 = b0 + b1*x0;
        if (isFinite(dx)) dyhat = b1*dx;

        // Intervals at X0 require: x0, xbar, SSx>0, RMSE (s), n, df, tcrit
        const canIntervals =
          isFinite(x0) && isFinite(yhatX0) &&
          isFinite(xbar) &&
          isFinite(SSx) && SSx > 0 &&
          isFinite(RMSE) && RMSE > 0 &&
          isFinite(n) && n > 0 &&
          isFinite(tcrit);

        if (canIntervals){
          const s = RMSE;
          const leveragePart = ( (x0 - xbar)*(x0 - xbar) ) / SSx;

          se_mean = s * Math.sqrt( (1/n) + leveragePart );
          se_pred = s * Math.sqrt( 1 + (1/n) + leveragePart );

          ci_mean_x0 = [ yhatX0 - tcrit*se_mean, yhatX0 + tcrit*se_mean ];
          pi_x0      = [ yhatX0 - tcrit*se_pred, yhatX0 + tcrit*se_pred ];
        }
      }

      // ANOVA / F (when SST & SSE exist)
      let MSR = NaN, F = NaN, pF = NaN;
      if (isFinite(SSE) && isFinite(SSR) && isFinite(df) && df>0){
        MSE = (isFinite(MSE) ? MSE : SSE/df);
        MSR = SSR; // df_reg = 1
        if (isFinite(MSE) && MSE > 0){
          F = MSR / MSE;
          pF = fRightTailPValue(F, 1, df);
        }
      }

      return {
        mode, alpha, h1, conf,
        n, df, b0, b1,
        xbar, ybar, SSx, SSy,
        r, R2,
        SSE, SSR, SST, MSE, RMSE,
        se_b1, tstat, pval, tcrit, ci_b1,
        x0, dx, yhatX0, dyhat,
        se_mean, se_pred,
        ci_mean_x0, pi_x0,
        MSR, F, pF
      };
    }

    /***********************
     * Rendering
     ***********************/
    function decisionText(p, alpha){
      if (!isFinite(p)) return {txt:"Not enough info for a hypothesis test.", cls:"status-warn"};
      if (p < alpha) return {txt:"Reject H0", cls:"status-good"};
      return {txt:"Fail to reject H0", cls:"status-warn"};
    }

    function renderModelBox(res){
      const box = document.getElementById("modelBox");
      const eq = `Ŷ = b0 + b1·X`;
      const line = `Ŷ = ${fmt(res.b0,6)} + (${fmt(res.b1,6)})·X`;

      box.innerHTML = `
        <div class="mono">${eq}</div>
        <div class="mono mt-2">${line}</div>
        <div class="mt-2">
          <b>Interpretation:</b> <span class="mono">b1</span> is the expected change in <span class="mono">Ŷ</span> for a +1 change in <span class="mono">X</span>.
        </div>
        <hr class="hr-soft my-3">
        <div><b>Key formulas used:</b></div>
        <div class="mono mt-2">
          b1 = Sxy / Sxx  (raw data)<br>
          b1 = r·(sᵧ/sₓ)  (summary stats)<br>
          b0 = ȳ − b1·x̄<br>
          df = n − 2<br>
          RMSE = s = √(SSE/df)<br>
          SE(b1) = s / √Sxx
        </div>
        <hr class="hr-soft my-3">
        <div><b>Intervals at X0:</b></div>
        <div class="mono mt-2">
          SE_mean(X0) = s·√(1/n + (X0−x̄)²/Sxx)<br>
          CI_mean: Ŷ(X0) ± t*·SE_mean(X0)<br><br>
          SE_pred(X0) = s·√(1 + 1/n + (X0−x̄)²/Sxx)<br>
          Prediction interval: Ŷ(X0) ± t*·SE_pred(X0)
        </div>
      `;
    }

    function renderAnova(res){
      const box = document.getElementById("anovaBox");
      const note = document.getElementById("anovaNote");

      if (!isFinite(res.SST) || !isFinite(res.SSE) || !isFinite(res.SSR)){
        box.innerHTML = `<div class="small-note status-warn">
          ANOVA cannot be fully computed in this mode unless SST/SSE/SSR are identifiable from inputs.
        </div>`;
        note.textContent = "";
        return;
      }

      const dfReg = 1;
      const dfErr = res.df;
      const dfTot = res.n - 1;
      const MSR = res.MSR;
      const MSE = res.MSE;

      box.innerHTML = `
        <div class="table-wrap table-wide">
          <table class="table table-dark table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th style="min-width:140px;">Source</th>
                <th class="mono">df</th>
                <th class="mono">SS</th>
                <th class="mono">MS</th>
                <th class="mono">F</th>
                <th class="mono">Significance F</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th>Regression</th>
                <td class="mono">${fmt(dfReg,0)}</td>
                <td class="mono">${fmt(res.SSR,6)}</td>
                <td class="mono">${isFinite(MSR) ? fmt(MSR,6) : "—"}</td>
                <td class="mono">${isFinite(res.F) ? fmt(res.F,6) : "—"}</td>
                <td class="mono">${isFinite(res.pF) ? fmt(res.pF,6) : "—"}</td>
              </tr>
              <tr>
                <th>Error</th>
                <td class="mono">${fmt(dfErr,0)}</td>
                <td class="mono">${fmt(res.SSE,6)}</td>
                <td class="mono">${isFinite(MSE) ? fmt(MSE,6) : "—"}</td>
                <td class="mono">—</td>
                <td class="mono">—</td>
              </tr>
              <tr>
                <th>Total</th>
                <td class="mono">${fmt(dfTot,0)}</td>
                <td class="mono">${fmt(res.SST,6)}</td>
                <td class="mono">—</td>
                <td class="mono">—</td>
                <td class="mono">—</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      note.innerHTML = `<span class="mono">SST = SSR + SSE</span> and <span class="mono">R² = SSR/SST</span>.`;
    }

    function buildWriteup(res){
      const h1Text =
        res.h1 === "two" ? "ρ ≠ 0 (two-sided)" :
        res.h1 === "gt" ? "ρ > 0 (right-tailed)" :
                          "ρ < 0 (left-tailed)";

      const dec = decisionText(res.pval, res.alpha);

      const predLines = [];
      if (isFinite(res.x0) && isFinite(res.yhatX0)) predLines.push(`Prediction: at X0=${res.x0}, Ŷ=${fmt(res.yhatX0,6)}.`);
      if (isFinite(res.dx) && isFinite(res.dyhat)) predLines.push(`Change: for deltaX=${res.dx}, predicted deltaŶ=${fmt(res.dyhat,6)}.`);

      const intervalLines = [];
      if (isFinite(res.ci_mean_x0[0])){
        intervalLines.push(`CI for mean response at X0 (${fmt(100*res.conf,0)}%): [${fmt(res.ci_mean_x0[0],6)}, ${fmt(res.ci_mean_x0[1],6)}].`);
      } else if (isFinite(res.x0)) {
        intervalLines.push(`CI(mean) at X0 not available (need x̄, Sxx, and RMSE/SE info).`);
      }

      if (isFinite(res.pi_x0[0])){
        intervalLines.push(`Prediction interval at X0 (${fmt(100*res.conf,0)}%): [${fmt(res.pi_x0[0],6)}, ${fmt(res.pi_x0[1],6)}].`);
      } else if (isFinite(res.x0)) {
        intervalLines.push(`Prediction interval at X0 not available (need x̄, Sxx, and RMSE/SE info).`);
      }

      return (
`Simple Linear Regression (SLR)

Model: Ŷ = b0 + b1·X
Estimated line: Ŷ = ${fmt(res.b0,6)} + (${fmt(res.b1,6)})·X

Association / slope test:
H0: ρ = 0  (equivalently: b1 = 0)
H1: ${h1Text}

Test statistic: t = ${fmt(res.tstat,6)} with df = ${fmt(res.df,0)}
p-value = ${fmt(res.pval,6)}
At α = ${fmt(res.alpha,4)}: ${dec.txt}

${isFinite(res.R2) ? `Explained variability: R² = ${fmt(res.R2,6)} (${fmt(100*res.R2,2)}% of Y variation explained by X).` : `Explained variability: R² not identifiable from the provided inputs.`}

${isFinite(res.ci_b1[0]) ? `Confidence interval for b1 (${fmt(100*res.conf,0)}%): [${fmt(res.ci_b1[0],6)}, ${fmt(res.ci_b1[1],6)}].` : `Confidence interval for b1: not available (missing SE info).`}

${predLines.concat(intervalLines).join("\n")}`
      ).trim();
    }

    function renderSteps(res){
      const steps = document.getElementById("stepsContainer");
      const dec = decisionText(res.pval, res.alpha);

      const h1Line =
        res.h1 === "two" ? "H1: ρ ≠ 0 (two-sided)" :
        res.h1 === "gt" ? "H1: ρ > 0 (right-tailed)" :
                          "H1: ρ < 0 (left-tailed)";

      const exSlope = (res.mode === "summary")
        ? `b1 = r·(sᵧ/sₓ) = (${fmt(res.r,6)})·(sᵧ/sₓ) = ${fmt(res.b1,6)}`
        : (res.mode === "raw")
          ? `b1 = Sxy/Sxx = ${fmt(res.b1,6)} (computed from your pasted pairs)`
          : `b1 is provided as input: ${fmt(res.b1,6)}`;

      const exIntercept = (isFinite(res.xbar) && isFinite(res.ybar))
        ? `b0 = ȳ − b1·x̄ = ${fmt(res.ybar,6)} − (${fmt(res.b1,6)})·${fmt(res.xbar,6)} = ${fmt(res.b0,6)}`
        : `b0 is provided as input: ${fmt(res.b0,6)}`;

      const seLine = isFinite(res.se_b1)
        ? `SE(b1) = s/√Sxx = ${fmt(res.RMSE,6)}/√${fmt(res.SSx,6)} = ${fmt(res.se_b1,6)}`
        : `SE(b1) cannot be computed because uncertainty input is missing.`;

      const tLine = isFinite(res.tstat)
        ? `t = b1 / SE(b1) = ${fmt(res.b1,6)} / ${fmt(res.se_b1,6)} = ${fmt(res.tstat,6)}`
        : `t-statistic not available (missing SE(b1)).`;

      const ciB1Line = isFinite(res.ci_b1[0])
        ? `${fmt(100*res.conf,0)}% CI for b1: b1 ± t*·SE(b1)
t* = t_{1−α/2, df} = ${fmt(res.tcrit,6)}
CI = ${fmt(res.b1,6)} ± ${fmt(res.tcrit,6)}·${fmt(res.se_b1,6)} = [${fmt(res.ci_b1[0],6)}, ${fmt(res.ci_b1[1],6)}]`
        : `CI for b1 not available (missing SE(b1)).`;

      // Interval calculations at X0
      let intervalSteps = `<div class="small-note status-warn">Intervals at X0 are not available (need X0, x̄, Sxx, and RMSE/SE info).</div>`;
      if (isFinite(res.ci_mean_x0[0]) && isFinite(res.pi_x0[0])){
        const s = res.RMSE;
        const lev = ((res.x0 - res.xbar)*(res.x0 - res.xbar))/res.SSx;

        intervalSteps = `
          <div class="small-note">
            First compute the standard errors at X0:
            <div class="mono mt-2">leverage part = (X0−x̄)²/Sxx = (${fmt(res.x0,6)}−${fmt(res.xbar,6)})²/${fmt(res.SSx,6)} = ${fmt(lev,6)}</div>
            <div class="mono mt-2">SE_mean(X0) = s·√(1/n + leverage) = ${fmt(s,6)}·√(1/${fmt(res.n,0)} + ${fmt(lev,6)}) = ${fmt(res.se_mean,6)}</div>
            <div class="mono mt-2">SE_pred(X0) = s·√(1 + 1/n + leverage) = ${fmt(s,6)}·√(1 + 1/${fmt(res.n,0)} + ${fmt(lev,6)}) = ${fmt(res.se_pred,6)}</div>
            <div class="small-note mt-3">
              With confidence level ${fmt(100*res.conf,0)}%, the critical value is
              <span class="mono">t* = ${fmt(res.tcrit,6)}</span>.
            </div>
            <div class="mono mt-2">CI_mean(X0): Ŷ(X0) ± t*·SE_mean = ${fmt(res.yhatX0,6)} ± ${fmt(res.tcrit,6)}·${fmt(res.se_mean,6)} = [${fmt(res.ci_mean_x0[0],6)}, ${fmt(res.ci_mean_x0[1],6)}]</div>
            <div class="mono mt-2">Prediction interval: Ŷ(X0) ± t*·SE_pred = ${fmt(res.yhatX0,6)} ± ${fmt(res.tcrit,6)}·${fmt(res.se_pred,6)} = [${fmt(res.pi_x0[0],6)}, ${fmt(res.pi_x0[1],6)}]</div>
            <div class="small-note mt-2">
              Interpretation: CI_mean is narrower (uncertainty about the mean). Prediction interval is wider (mean uncertainty + new observation noise).
            </div>
          </div>
        `;
      }

      steps.innerHTML = `
        <div class="step">
          <div class="fw-semibold mb-1">Step 1 — State the model</div>
          <div class="small-note">
            Simple linear regression models the conditional mean of Y as a line in X:
            <div class="mono mt-2">Ŷ = b0 + b1·X</div>
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 2 — Compute the fitted line (b0 and b1)</div>
          <div class="small-note">
            ${res.mode === "raw"
              ? `From raw data, compute x̄, ȳ, Sxx=Σ(x−x̄)², Sxy=Σ(x−x̄)(y−ȳ), then b1=Sxy/Sxx and b0=ȳ−b1·x̄.`
              : res.mode === "summary"
                ? `From summary stats, use b1=r·(sᵧ/sₓ), then b0=ȳ−b1·x̄.`
                : `In output mode, b0 and b1 may be given directly.`}
            <div class="mono mt-2">${exSlope}</div>
            <div class="mono mt-2">${exIntercept}</div>
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 3 — Strength of relationship (r and R²)</div>
          <div class="small-note">
            R² is the proportion of Y variation explained by the linear fit.
            ${isFinite(res.R2)
              ? `<div class="mono mt-2">R² = ${fmt(res.R2,6)} (${fmt(100*res.R2,2)}%)</div>`
              : `<div class="small-note status-warn mt-2">R² is not identifiable from the given inputs in this mode.</div>`}
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 4 — Compute RMSE (s) and SE(b1)</div>
          <div class="small-note">
            RMSE (denoted s) is the estimated standard deviation of residuals:
            <div class="mono mt-2">s = RMSE = √(SSE/df),  df = n−2</div>
            <div class="mono mt-2">${seLine}</div>
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 5 — Hypothesis test for association</div>
          <div class="small-note">
            We test whether the slope is zero (no linear association):
            <div class="mono mt-2">H0: ρ=0 (equivalently b1=0)</div>
            <div class="mono">${h1Line}</div>
            <div class="mono mt-2">${tLine}</div>
            ${isFinite(res.pval)
              ? `<div class="mono mt-2">p-value = ${fmt(res.pval,6)}</div>`
              : `<div class="small-note status-warn mt-2">p-value not available (missing SE(b1)).</div>`}
            <div class="small-note mt-2">
              Decision rule: reject H0 if <span class="mono">p-value &lt; α</span>.
              <div class="${dec.cls} fw-bold mt-1">${dec.txt}</div>
            </div>
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 6 — Confidence interval for b1</div>
          <div class="small-note">
            ${ciB1Line}
          </div>
        </div>

        <div class="step">
          <div class="fw-semibold mb-1">Step 7 — Predictions & intervals at X0</div>
          <div class="small-note">
            Point prediction:
            <div class="mono mt-2">Ŷ(X0) = b0 + b1·X0 = ${fmt(res.yhatX0,6)}</div>
            Change prediction:
            <div class="mono mt-2">deltaŶ = b1·deltaX = ${fmt(res.dyhat,6)}</div>
            <hr class="hr-soft my-3">
            <div class="fw-semibold mb-2">Intervals at X0</div>
            ${intervalSteps}
          </div>
        </div>
      `;
    }

    function render(res){
      // KPIs
      // Add <wbr> break opportunities around operators so it wraps cleanly on smaller cards
      document.getElementById("kpiLine").innerHTML =
        `Ŷ = ${fmt(res.b0,4)} <wbr> + <wbr> (${fmt(res.b1,4)})·X`;

      const r2Text = isFinite(res.R2)
        ? `r=${fmt(res.r,6)}, R²=${fmt(res.R2,6)}`
        : `r/R²: — (not identifiable in this mode)`;
      document.getElementById("kpiR2").textContent = r2Text;

      document.getElementById("kpiT").textContent =
        isFinite(res.tstat) ? `t=${fmt(res.tstat,6)}, df=${fmt(res.df,0)}` : `—`;

      const dec = decisionText(res.pval, res.alpha);
      const decEl = document.getElementById("kpiDecision");
      decEl.textContent = isFinite(res.pval)
        ? `p=${fmt(res.pval,6)} • ${dec.txt}`
        : `—`;
      decEl.classList.remove("status-good","status-warn","status-bad");
      decEl.classList.add(dec.cls);

      // Uncertainty
      document.getElementById("kpiSSE").textContent = fmt(res.SSE,6);
      document.getElementById("kpiRMSE").textContent = fmt(res.RMSE,6);
      document.getElementById("kpiSEb1").textContent = fmt(res.se_b1,6);
      document.getElementById("kpiCIb1").textContent =
        isFinite(res.ci_b1[0]) ? `[${fmt(res.ci_b1[0],6)}, ${fmt(res.ci_b1[1],6)}]` : `—`;

      // Predictions & intervals
      document.getElementById("kpiYhatX0").textContent = fmt(res.yhatX0,6);
      document.getElementById("kpiDY").textContent = fmt(res.dyhat,6);

      document.getElementById("kpiCIMeanX0").textContent =
        isFinite(res.ci_mean_x0[0]) ? `[${fmt(res.ci_mean_x0[0],6)}, ${fmt(res.ci_mean_x0[1],6)}]` : `—`;

      document.getElementById("kpiPIX0").textContent =
        isFinite(res.pi_x0[0]) ? `[${fmt(res.pi_x0[0],6)}, ${fmt(res.pi_x0[1],6)}]` : `—`;

      const note = document.getElementById("intervalNote");
      if (isFinite(res.x0) && !(isFinite(res.ci_mean_x0[0]) && isFinite(res.pi_x0[0]))){
        note.innerHTML = `<span class="status-warn">
          Intervals at X0 require <span class="mono">x̄</span>, <span class="mono">Sxx</span>, and <span class="mono">RMSE (s)</span> (or equivalent SE info).
        </span>`;
      } else {
        note.textContent = "";
      }

      renderModelBox(res);
      renderAnova(res);
      renderSteps(res);

      document.getElementById("writeupPreview").textContent = buildWriteup(res);

      initTooltips();
    }

    /***********************
     * UI wiring
     ***********************/
    function setMode(mode){
      document.getElementById("modeRaw").classList.toggle("d-none", mode!=="raw");
      document.getElementById("modeSummary").classList.toggle("d-none", mode!=="summary");
      document.getElementById("modeOutput").classList.toggle("d-none", mode!=="output");
    }

    function computeAndRender(){
      const res = compute();
      if (res) render(res);
    }

    function resetAll(){
      clearError();
      document.getElementById("modeSelect").value = "raw";
      setMode("raw");
      document.getElementById("rawPairs").value = "";
      document.getElementById("alphaSelect").value = "0.05";
      document.getElementById("h1Select").value = "two";
      document.getElementById("confSelect").value = "0.95";
      document.getElementById("predToggle").checked = true;
      document.getElementById("predBlock").classList.remove("d-none");
      document.getElementById("x0Input").value = "";
      document.getElementById("dxInput").value = "";

      // summary defaults
      document.getElementById("nSummary").value = "30";
      document.getElementById("rSummary").value = "0.6";
      document.getElementById("xbarSummary").value = "50";
      document.getElementById("ybarSummary").value = "100";
      document.getElementById("sxSummary").value = "10";
      document.getElementById("sySummary").value = "20";

      // output defaults
      document.getElementById("b0Out").value = "0";
      document.getElementById("b1Out").value = "1";
      document.getElementById("nOut").value = "30";
      document.getElementById("xbarOut").value = "";
      document.getElementById("ssxOut").value = "1000";
      document.getElementById("seB1Out").value = "";
      document.getElementById("rmseOut").value = "";
      document.getElementById("sseOut").value = "";

      // clear results
      [
        "kpiLine","kpiR2","kpiT","kpiDecision",
        "kpiSSE","kpiRMSE","kpiSEb1","kpiCIb1",
        "kpiYhatX0","kpiDY","kpiCIMeanX0","kpiPIX0"
      ].forEach(id => document.getElementById(id).textContent = "—");

      document.getElementById("intervalNote").textContent = "";
      document.getElementById("modelBox").innerHTML = "";
      document.getElementById("anovaBox").innerHTML = "";
      document.getElementById("anovaNote").innerHTML = "";
      document.getElementById("stepsContainer").innerHTML = "";
      document.getElementById("writeupPreview").textContent = "";

      initTooltips();
    }

    function loadExample(){
      // Generic example dataset (no course references)
      document.getElementById("modeSelect").value = "raw";
      setMode("raw");
      document.getElementById("rawPairs").value =
`10, 72
11, 74
12, 79
13, 81
14, 86
15, 89
16, 92
17, 95`;
      document.getElementById("x0Input").value = "14";
      document.getElementById("dxInput").value = "2";
      computeAndRender();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTooltips();
      setMode(document.getElementById("modeSelect").value);

      document.getElementById("modeSelect").addEventListener("change", (e)=> setMode(e.target.value));

      document.getElementById("predToggle").addEventListener("change", (e)=>{
        document.getElementById("predBlock").classList.toggle("d-none", !e.target.checked);
      });

      document.getElementById("btnCompute").addEventListener("click", computeAndRender);
      document.getElementById("btnComputeTop").addEventListener("click", computeAndRender);
      document.getElementById("btnComputeBottom").addEventListener("click", computeAndRender);

      document.getElementById("btnReset").addEventListener("click", resetAll);
      document.getElementById("btnExample").addEventListener("click", loadExample);

      document.getElementById("btnAlphaCustom").addEventListener("click", ()=>{
        const custom = document.getElementById("alphaCustom");
        const sel = document.getElementById("alphaSelect");
        const isCustom = !custom.classList.contains("d-none");
        if (isCustom){
          custom.classList.add("d-none");
          sel.classList.remove("d-none");
          document.getElementById("btnAlphaCustom").textContent = "Custom";
        } else {
          custom.classList.remove("d-none");
          sel.classList.add("d-none");
          custom.value = sel.value;
          document.getElementById("btnAlphaCustom").textContent = "Use preset";
        }
      });

      document.getElementById("btnConfCustom").addEventListener("click", ()=>{
        const custom = document.getElementById("confCustom");
        const sel = document.getElementById("confSelect");
        const isCustom = !custom.classList.contains("d-none");
        if (isCustom){
          custom.classList.add("d-none");
          sel.classList.remove("d-none");
          document.getElementById("btnConfCustom").textContent = "Custom";
        } else {
          custom.classList.remove("d-none");
          sel.classList.add("d-none");
          custom.value = sel.value;
          document.getElementById("btnConfCustom").textContent = "Use preset";
        }
      });

      function hasResults(){
        return (document.getElementById("stepsContainer").innerHTML || "").trim().length > 0;
      }

      document.getElementById("alphaSelect").addEventListener("change", ()=>{ if (hasResults()) computeAndRender(); });
      document.getElementById("alphaCustom").addEventListener("input", ()=>{ if (hasResults()) computeAndRender(); });

      document.getElementById("confSelect").addEventListener("change", ()=>{ if (hasResults()) computeAndRender(); });
      document.getElementById("confCustom").addEventListener("input", ()=>{ if (hasResults()) computeAndRender(); });

      document.getElementById("btnCopyWriteup").addEventListener("click", async ()=>{
        const txt = document.getElementById("writeupPreview").textContent;
        if (!txt.trim()) return;
        try{
          await navigator.clipboard.writeText(txt);
          const btn = document.getElementById("btnCopyWriteup");
          const old = btn.innerHTML;
          btn.innerHTML = `<i class="fa-solid fa-check me-2"></i>Copied`;
          setTimeout(()=> btn.innerHTML = old, 900);
        }catch(e){
          showError("Clipboard copy failed due to browser permissions. You can still manually select and copy the write-up text.");
        }
      });
    });
  </script>
</body>
</html>
